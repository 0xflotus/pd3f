<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
        />
        <meta http-equiv="X-UA-Compatible" content="chrome=1, IE=edge" />
        <title>{{job_id}}</title>
        <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.min.css" />
        <script defer src="/static/bootstrap/js/bootstrap.min.js"></script>
    </head>
    <body>
        <div class="container">
            <table class="table my-5">
                <thead>
                    <tr>
                        <th>job id</th>
                        <th>{{job_id}}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>file</td>
                        <td>{{filename[22:]}}</td>
                    </tr>
                    <tr>
                        <td>language</td>
                        <td>{{lang}}</td>
                    </tr>
                    <tr>
                        <td>check tables</td>
                        <td>{{tables}}</td>
                    </tr>
                    <tr>
                        <td>experimental mode</td>
                        <td>{{experimental}}</td>
                    </tr>
                    <tr>
                        <td>status</td>
                        <td id="status">
                            <span class="badge badge-secondary"
                                >waiting...</span
                            >
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="mb-5" id="downloads"></div>

            <div class="card">
                <h5 class="card-header">text output</h5>
                <div class="card-body">
                    <p id="output"></p>
                </div>
            </div>

            <div class="card mt-5">
                <h5 class="card-header">tables output</h5>
                <div class="card-body">
                    <p id="tables"></p>
                </div>
            </div>

            <div class="card mt-5">
                <h5 class="card-header">log output</h5>
                <div class="card-body">
                    <p id="log"></p>
                </div>
            </div>
        </div>
        <script>
            async function update() {
                const url = "/update/{{job_id}}";
                const response = await fetch(url);

                if (response.ok) {
                    const json = await response.json();

                    const statusElem = document.getElementById("status");
                    if ("log" in json) {
                        const logElem = document.getElementById("log");
                        if (json.log.length == 0)
                            logElem.innerHTML = "no logs yet";
                        else
                            logElem.innerHTML = json.log.replace(/\n/g, "<br>");
                    }

                    if ("text" in json) {
                        const outputElem = document.getElementById("output");
                        outputElem.innerHTML = json.text.replace(/\n/g, "<br>");
                        statusElem.innerHTML =
                            '<span class="badge badge-success">done</span>';

                        buttons =
                            '<a class="btn btn-primary mr-5" href="/files/{{filename}}" role="button">download pdf</a> <a class="btn btn-primary mr-5" href="/files/{{filename}}.txt" role="button">download text</a>';

                        if ("tables" in json) {
                            if (json.tables.length > 1) {
                                buttons +=
                                    '<a class="btn btn-primary" href="/files/{{filename}}_tables.zip" role="button">download tables (zip)</a>';

                                const tablesElem = document.getElementById(
                                    "tables"
                                );

                                let tablesStr = "";
                                json.tables.forEach((x, i) => {
                                    tablesStr +=
                                        "table #" +
                                        i +
                                        "<br><br>" +
                                        x +
                                        "<br><br>";
                                });
                                tablesElem.innerHTML = tablesStr;
                            }
                        }
                        const downloadsElem = document.getElementById(
                            "downloads"
                        );
                        downloadsElem.innerHTML = buttons;

                        clearInterval(window.pdddfInterval);
                    } else {
                        if ("failed" in json) {
                            statusElem.innerHTML =
                                '<span class="badge badge-danger">an error occured</span>';
                        } else {
                            if (json.position != -1)
                                statusElem.innerHTML =
                                    '<span class="badge badge-secondary">"waiting list position: ' +
                                    json.position +
                                    "Secondary</span>";
                            else
                                statusElem.innerHTML =
                                    '<span class="badge badge-info">running</span>';
                        }
                    }
                } else {
                    alert("HTTP-Error: " + response.status);
                }
            }
            window.pdddfInterval = setInterval(update, 500);
        </script>
    </body>
</html>
